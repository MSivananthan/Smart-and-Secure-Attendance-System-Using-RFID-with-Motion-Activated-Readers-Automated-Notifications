<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance System - Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-light: #f8fafc;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --success-color: #22c55e;
            --warning-color: #eab308;
            --error-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--background-light);
            color: var(--text-dark);
        }

        /* Split Login Page */
        .login-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        .login-left {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            width: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: white;
        }

        .login-left h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .feature-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
            width: 100%;
            max-width: 500px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-right {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            width: 400px;
            text-align: center;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .login-box h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            padding: 1.5rem;
            box-shadow: 4px 0 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: fixed; /* Make sidebar fixed */
            height: 100vh; /* Full viewport height */
            top: 0;
            left: 0;
            z-index: 1000; /* Ensure it stays on top */
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: var(--background-light);
            color: var(--primary-color);
        }

        .user-info {
            padding: 0.75rem 1rem;
            margin-top: auto;
            margin-bottom: 1rem;
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
            color: var(--text-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            margin-left: 250px; /* Offset for fixed sidebar */
        }

        /* Dashboard */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
        }

        .refresh-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }


        .overview-header h2 {
            margin-bottom: 0.25rem;
        }

        .overview-header p {
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .overview-header .tagline {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .stat-card.time-card { /* Reduced time card size */
            width: auto; /* Allow content to dictate width */
            padding: 0.75rem 1rem; /* Smaller padding */
            min-width: unset; /* Remove min-width constraint */
            flex: unset; /* Don't allow it to grow */
        }

        .stat-card.time-card p { /* Specific style for current time */
            font-size: 1.1rem; /* Further reduced font size */
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-color);
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        /* Table Styles (from html.html, adjusted for attendance-table) */
        .attendance-table {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .attendance-table h3 {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: var(--background-light);
            font-weight: 600;
            color: var(--text-dark);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Additional styles from indexx.html for attendance table */
        /* Note: This block might conflict with .attendance-table above.
           I'm keeping it as per "don't remove anything" but be aware of potential style overrides.
           The #attendance-table in the dashboard will use the .attendance-table styles.
           The #attendance-table from indexx.html is not present in this html.html file.
           So, these specific styles for #attendance-table below are not applied to any element in this file.
        */
        #attendance-table {
            border-collapse: collapse;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 30px; /* Centered with margin */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); /* Slightly different shadow */
            background: white;
            border-radius: 8px; /* Slightly different radius */
            overflow: hidden;
        }

        #attendance-table thead {
            background-color: #007bff; /* Different header color */
            color: white;
            font-weight: 600;
        }

        #attendance-table th,
        #attendance-table td {
            padding: 12px 15px; /* Different padding */
            text-align: center; /* Centered text */
            border-bottom: 1px solid #ddd; /* Lighter border */
            font-size: 14px; /* Smaller font size */
        }

        #attendance-table tbody tr:hover {
            background-color: #f1faff; /* Hover effect */
        }

        #attendance-table tbody tr:last-child td {
            border-bottom: none;
        }

        button.excel-btn { /* Specific style for save excel button */
            display: block;
            margin: 20px auto;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
        }

        button.excel-btn:hover {
            background-color: #0056b3;
        }

        #save-status {
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
            color: #28a745;
            min-height: 24px;
            font-size: 15px;
        }

        @media (max-width: 600px) {
            #attendance-table, button.excel-btn {
                width: 100%;
                font-size: 13px;
            }
            #attendance-table th, #attendance-table td {
                padding: 10px 8px;
            }
        }


        /* User Management */
        .user-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .rfid-section {
            background: var(--background-light);
            padding: 2rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .rfid-display {
            width: 100%;
            height: 150px;
            background: rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
            word-break: break-all;
            padding: 1rem;
        }

        .profile-image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .profile-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            margin-bottom: 0.5rem;
            background-color: #e2e8f0;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }

        /* Reports */
        .date-presets {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .date-btn {
            background: var(--background-light);
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .date-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .date-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .date-range-picker {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        /* Report Download Buttons */
        .report-download-options {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .report-download-options .btn {
            width: auto;
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
        }

        /* Settings */
        .settings-section { /* New class for individual setting containers */
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem; /* Space between sections */
        }

        .settings-section h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .time-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .work-days {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .work-day label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--background-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s ease;
        }

        .work-day input[type="checkbox"]:checked + label {
            background: var(--primary-color);
            color: white;
        }

        /* Enhanced Notification Settings */
        .notification-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: var(--background-light);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }

        .notification-item:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .notification-item input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-item input[type="checkbox"]::before {
            content: "\f00c"; /* FontAwesome check icon */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            font-size: 1rem;
            color: white;
            transform: scale(0);
            transition: transform 0.2s ease;
        }

        .notification-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .notification-item input[type="checkbox"]:checked::before {
            transform: scale(1);
        }

        /* All Employee Details */
        .employee-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Two columns, responsive */
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .employee-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); /* Slightly stronger initial shadow */
            border: 1px solid #e2e8f0; /* Add a subtle border */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* More pronounced shadow on hover */
        }

        .employee-card .profile-initials {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            margin-bottom: 1rem;
            background-color: var(--secondary-color); /* Background for initials */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .employee-card img { /* Style for actual uploaded images */
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .employee-card h4 {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 1.4rem; /* Slightly larger name */
        }

        .employee-card p {
            font-size: 1rem; /* Slightly larger text */
            color: var(--text-light);
            margin-bottom: 0.5rem; /* More spacing between lines */
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
        }

        .modal-header.success h3 { color: var(--success-color); }
        .modal-header.warning h3 { color: var(--warning-color); }
        .modal-header.error h3 { color: var(--error-color); }

        .close-button {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s ease;
        }

        .close-button:hover {
            color: var(--text-dark);
        }

        .modal-body {
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }

        .modal-footer {
            text-align: right;
        }

        .modal-footer .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
        }

        .modal-footer .btn + .btn {
            margin-left: 0.75rem;
        }


        /* New View */
        .new-view-section {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }

        /* Transitions */
        .main-content > div {
            transition: opacity 0.3s ease, transform 0.3s ease;
            will-change: opacity, transform;
        }

        .hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            width: 100%;
            height: 0;
            overflow: hidden;
        }

        .active-section {
            opacity: 1;
            transform: translateY(0);
            position: relative;
            height: auto;
            overflow: visible;
        }

        /* Select Styles */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .login-container {
                flex-direction: column;
            }

            .login-left, .login-right {
                width: 100%;
                min-height: 50vh;
            }

            .login-box {
                width: 90%;
                max-width: 450px;
            }

            .feature-cards {
                grid-template-columns: 1fr 1fr;
            }

            .sidebar {
                position: relative; /* Unfix sidebar on smaller screens */
                width: 100%;
                height: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }

            .main-content {
                margin-left: 0; /* Remove margin when sidebar is not fixed */
            }
        }

        @media (max-width: 768px) {
            .user-form-grid,
            .employee-details-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .feature-cards {
                grid-template-columns: 1fr;
            }

            .date-range-picker {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="login-container" id="loginPage">
        <div class="login-left">
            <h1>Smart Attendance System</h1>
            <p>Powered by RFID Technology</p>
            <div class="feature-cards">
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-users"></i></div>
                    <h3>User Management</h3>
                    <p>Easily manage employee profiles and RFID cards</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>Real-time Reports</h3>
                    <p>Access attendance data instantly</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-bell"></i></div>
                    <h3>Notifications</h3>
                    <p>Get alerts for late arrivals and absences</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-cogs"></i></div>
                    <h3>Customizable</h3>
                    <p>Adjust settings to fit your needs</p>
                </div>
            </div>
            <p style="margin-top: 2rem;">Powered by RFID Attendance</p>
        </div>
        <div class="login-right">
            <div class="login-box">
                <h2>Admin Login</h2>
                <form id="loginForm" onsubmit="return login(event)">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container hidden" id="mainContainer">
        <div class="sidebar">
            <div class="logo">Smart Attendance</div>
            <div class="menu-item active" onclick="showSection('dashboard')">
                <i class="fas fa-chart-pie"></i> Dashboard
            </div>
            <div class="menu-item" onclick="showSection('users')">
                <i class="fas fa-user-friends"></i> User Management
            </div>
            <div class="menu-item" onclick="showSection('employeeDetails')">
                <i class="fas fa-users-cog"></i> Employee Details
            </div>
            <div class="menu-item" onclick="showSection('reports')">
                <i class="fas fa-file-alt"></i> Reports
            </div>
            <div class="menu-item" onclick="showSection('settings')">
                <i class="fas fa-cog"></i> Settings
            </div>
            <div class="user-info">
                <i class="fas fa-user-circle"></i> <span id="sidebarUsername">Admin</span>
            </div>
            <div class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </div>
        </div>

        <div class="main-content">
            <div id="dashboard" class="active-section">
                <div class="dashboard-container">
                    <div class="overview-header">
                        <div>
                            <h2 id="welcomeMessage">Hi Admin</h2>
                            <p class="tagline"><strong><h4>Empowering seamless attendance tracking.</h4></strong></p>
                            <p id="currentDate" style="color: var(--text-light);"></p>
                        </div>
                        <div class="stat-card time-card">
                            <h3>Current Time</h3>
                            <p id="currentTime">00:00 AM</p>
                        </div>
                        <button class="refresh-btn" onclick="fetchAttendanceSummary()">Refresh</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-users"></i></div>
                            <h3>Total Users</h3>
                            <p id="totalUsers">0</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-check-circle" style="color: var(--success-color);"></i></div>
                            <h3>Present</h3>
                            <p id="presentUsers">0 (0%)</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-hourglass-half" style="color: var(--warning-color);"></i></div>
                            <h3>Late</h3>
                            <p id="lateUsers">0 (0%)</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-times-circle" style="color: var(--error-color);"></i></div>
                            <h3>Absent</h3>
                            <p id="absentUsers">0 (0%)</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-fingerprint"></i></div>
                            <h3>Today's Check-ins</h3>
                            <p id="todayCheckinsCount">0</p>
                        </div>
                    </div>
                    <div class="attendance-table">
                        <h3>Today's Attendance</h3>
                        <table id="attendance-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Check-in Time</th>
                                    <th>Work Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button class="excel-btn" onclick="saveExcel()">Save Excel</button>
                        <p id="save-status"></p>
                    </div>
                </div>
            </div>

            <div id="users" class="hidden">
                <div class="dashboard-container">
                    <h2>User Management</h2>
                    <div class="user-form-grid">
                        <div>
                            <h3>Add New User</h3>
                            <br>
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" placeholder="Enter full name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" placeholder="Enter email address" required>
                            </div>
                            <div class="form-group">
                                <label for="department">Department</label>
                                <select id="department" required>
                                    <option value="">Select Department</option>
                                    <option>HR</option>
                                    <option>Software Developer</option>
                                    <option>Web Developer</option>
                                    <option>Tester</option>
                                    <option>Infrastructure</option>
                                    <option>Quality Analyst</option>
                                    <option>Service Now</option>
                                    <option>Tech Support</option>
                                    <option>Infrastructure Management</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rfidInput">RFID Tag (Optional)</label>
                                <input type="text" id="rfidInput" placeholder="Enter RFID manually or scan">
                                <small>Leave blank to scan or generate automatically.</small>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button class="btn" style="flex: 1;" onclick="addNewUser()">Add User</button>
                                <button class="btn" style="flex: 1; background-color: #10b981;" onclick="generateRfidNoScan()">Generate RFID (No Scan)</button>
                            </div>
                        </div>
                        <div class="rfid-section">
                            <h3>Scan RFID for New User</h3>
                            <p>Fill user details on the left, then tap card here to assign RFID.</p>
                            <div class="rfid-display" id="rfidDisplay">Waiting for Scan...</div>
                            <button class="btn" onclick="scanRFIDForNewUser()">Scan RFID to Assign</button>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                <i class="fas fa-info-circle"></i> This will associate the scanned RFID with the user currently being added.
                            </p>
                        </div>
                    </div>
                    <div class="attendance-table">
                        <h3>Registered Users</h3>
                        <table id="registeredUsersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Department</th>
                                    <th>RFID ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="employeeDetails" class="hidden">
                <div class="dashboard-container">
                    <h2>All Employee Details</h2>
                    <div class="report-download-options" style="margin-left: 60%; margin-bottom: 1.5rem;">
                        <button class="btn" onclick="downloadEmployeeDetailsExcel()">Download as Excel</button>
                        <button class="btn" onclick="downloadEmployeeDetailsPdf()">Download as PDF</button>
                    </div>
                    <div id="employeeDetailsGrid" class="employee-details-grid">
                        <p style="text-align: center; width: 100%; color: var(--text-light);">Loading employee details...</p>
                    </div>
                </div>
            </div>

            <div id="reports" class="hidden">
                <div class="dashboard-container">
                    <h2>Attendance Reports</h2>
                    <br>
                    <div class="date-presets">
                        <button class="date-btn active" onclick="setDateRange('today', this)">Today</button>
                        <button class="date-btn" onclick="setDateRange('yesterday', this)">Yesterday</button>
                        <button class="date-btn" onclick="setDateRange('week', this)">This Week</button>
                        <button class="date-btn" onclick="setDateRange('month', this)">This Month</button>
                        <button class="date-btn" onclick="setDateRange('custom', this)">Custom</button>
                    </div>
                    <div class="date-range-picker">
                        <input type="date" id="startDate" class="form-control">
                        <span>to</span>
                        <input type="date" id="endDate" class="form-control">
                        <button class="btn" onclick="generateReport()">Generate Report</button>
                        <button class="refresh-btn" onclick="generateReport()">Refresh Report</button>
                    </div>
                    <div class="attendance-table">
                        <h3>Attendance Report</h3>
                        <table id="reportsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Check-in Time</th>
                                    <th>Work Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="report-download-options">
                        <button class="btn" onclick="downloadReportExcel()">Download as Excel</button>
                        <button class="btn" onclick="downloadReportPdf()">Download as PDF</button>
                        <button class="btn" onclick="sendReportEmail()">Send as Email</button>
                    </div>
                </div>
            </div>

            <div id="settings" class="hidden">
                <div class="dashboard-container">
                    <h2>System Settings</h2>
                    <div class="settings-section">
                        <h3>Attendance Settings</h3>
                        <div class="form-group">
                            <label>Check-In Period</label>
                            <div class="time-input-group">
                                <input type="time" value="09:00" id="checkInStart">
                                <input type="time" value="10:00" id="checkInEnd">
                            </div>
                            <small>Employees checking in after end time will be marked late</small>
                        </div>
                        <div class="form-group">
                            <label>Work Days</label>
                            <div class="work-days">
                                <div class="work-day">
                                    <input type="checkbox" id="monday" checked>
                                    <label for="monday">Mon</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="tuesday" checked>
                                    <label for="tuesday">Tue</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="wednesday" checked>
                                    <label for="wednesday">Wed</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="thursday" checked>
                                    <label for="thursday">Thu</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="friday" checked>
                                    <label for="friday">Fri</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="saturday">
                                    <label for="saturday">Sat</label>
                                </div>
                                <div class="work-day">
                                    <input type="checkbox" id="sunday">
                                    <label for="sunday">Sun</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Notification Settings</h3>
                        <div class="notification-item">
                            <input type="checkbox" id="notifyLateArrivals" checked>
                            <label for="notifyLateArrivals">Send notifications for late arrivals</label>
                        </div>
                        <div class="notification-item">
                            <input type="checkbox" id="notifyAbsences" checked>
                            <label for="notifyAbsences">Send notifications for absences</label>
                        </div>
                        <div class="notification-item">
                            <input type="checkbox" id="emailSummary" checked>
                            <label for="emailSummary">Email daily attendance summary</label>
                        </div>
                        <div class="form-group">
                            <label for="notificationEmail">Notification Email Address</label>
                            <input type="email" id="notificationEmail" value="admin@example.com">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>RFID Reader Settings</h3>
                        <div class="form-group">
                            <label for="comPort">Serial Port (COM Port)</label>
                            <input type="text" id="comPort" value="COM7">
                            <small>The serial port your RFID reader is connected to (e.g., COM7 or /dev/ttyUSB0)</small>
                        </div>
                        <div class="form-group">
                            <label for="baudRate">Baud Rate</label>
                            <input type="number" id="baudRate" value="9600">
                            <small>Baud rate for serial communication (e.g., 9600)</small>
                        </div>
                        <button class="btn" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="alertTitle">Alert</h3>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="alertMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Global variable to store currently scanned RFID for new user assignment
        let scannedRfidForNewUser = '';
        let employees = []; // This will be populated from the backend

        // Mock authentication for demonstration
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'admin') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                document.getElementById('sidebarUsername').textContent = username;
                updateDateTime();
                // fetchAttendanceSummary(); // Initial fetch on login, will be triggered by RFID tap
                setInterval(updateDateTime, 1000); // Update time every second
                loadSettings(); // Load settings on login
                fetchRegisteredUsers(); // Fetch registered users on login
                showSection('dashboard'); // Default to dashboard
                return false;
            } else {
                showAlert('Login Failed', 'Invalid username or password.', 'error');
                return false;
            }
        }

        function logout() {
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginForm').reset(); // Clear login form
            showAlert('Logged Out', 'You have been successfully logged out.', 'success');
        }

        // Section management
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.main-content > div');
            sections.forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active-section');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('active-section');

            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            document.querySelector(`.menu-item[onclick="showSection('${sectionId}')"]`).classList.add('active');

            if (sectionId === 'employeeDetails') {
                renderEmployeeDetails();
            } else if (sectionId === 'reports') {
                // Set initial date range for reports and generate report
                const today = formatDate(new Date());
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
                // Set "Today" button as active initially
                document.querySelector('.date-presets .date-btn:first-child').classList.add('active');
                generateReport(); // Generate report for today by default
            } else if (sectionId === 'users') {
                fetchRegisteredUsers(); // Refresh registered users table
            }
        }

        // Date and Time update
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };

            document.getElementById('currentDate').textContent = now.toLocaleDateString(undefined, dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString(undefined, timeOptions);
        }

        // Modal functions
        function showAlert(title, message, type = 'info') {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            const modalHeader = document.querySelector('#alertModal .modal-header');
            modalHeader.classList.remove('success', 'warning', 'error');
            if (type === 'success') modalHeader.classList.add('success');
            else if (type === 'warning') modalHeader.classList.add('warning');
            else if (type === 'error') modalHeader.classList.add('error');
            document.getElementById('alertModal').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('alertModal').classList.remove('visible');
        }

        // Attendance data fetching and display
        async function fetchAttendanceSummary() {
            try {
                const response = await fetch('/summary');
                const summary = await response.json();
                console.log("Fetched attendance summary:", summary); // Debugging
                updateDashboardStats(summary);
                updateDashboardAttendanceTable(summary);
            } catch (error) {
                console.error("Error fetching attendance summary:", error);
                showAlert('Error', 'Could not fetch attendance summary. Please check the backend server.', 'error');
            }
        }

        function updateDashboardStats(summary) {
            document.getElementById('totalUsers').textContent = summary.total_users_registered;
            document.getElementById('presentUsers').textContent = `${summary.present} (${(summary.present / summary.total_users_registered * 100 || 0).toFixed(0)}%)`;
            document.getElementById('lateUsers').textContent = `${summary.late} (${(summary.late / summary.total_users_registered * 100 || 0).toFixed(0)}%)`;
            document.getElementById('absentUsers').textContent = `${summary.absent}`;
            document.getElementById('todayCheckinsCount').textContent = summary.total_check_ins;
        }

        function updateDashboardAttendanceTable(summary) {
            const tableBody = document.querySelector('#dashboard #attendance-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (summary.detail && summary.detail.length > 0) {
                summary.detail.forEach(record => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = record.name;
                    row.insertCell().textContent = record.date;
                    row.insertCell().textContent = record.department;
                    row.insertCell().textContent = record.status;
                    row.insertCell().textContent = record.check_in_time;
                    row.insertCell().textContent = record.work_hours;
                });
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = 'var(--text-light)';
                cell.textContent = 'No attendance records for today';
            }
        }

        // Function to save Excel from the backend
        async function saveExcel() {
            const statusElem = document.getElementById('save-status');
            statusElem.textContent = 'Saving...';
            try {
                const response = await fetch('/save');
                const data = await response.json();
                if (response.ok) {
                    statusElem.textContent = data.message;
                    setTimeout(() => { statusElem.textContent = ''; }, 5000);
                } else {
                    statusElem.textContent = data.message || 'Error saving Excel.';
                    setTimeout(() => { statusElem.textContent = ''; }, 5000);
                }
            } catch (error) {
                console.error('Error:', error);
                statusElem.textContent = 'Error saving Excel.';
                setTimeout(() => { statusElem.textContent = ''; }, 5000);
            }
        }

        // User Management Functions
        async function fetchRegisteredUsers() {
            try {
                const response = await fetch('/users');
                const data = await response.json();
                employees = data.users; // Update the global employees array
                renderRegisteredUsersTable();
                renderEmployeeDetails(); // Also update employee details section
            } catch (error) {
                console.error("Error fetching registered users:", error);
                showAlert('Error', 'Could not fetch registered users. Please check the backend server.', 'error');
            }
        }

        function renderRegisteredUsersTable() {
            const tableBody = document.querySelector('#registeredUsersTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (employees.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = 'var(--text-light)';
                cell.textContent = 'No registered users.';
                return;
            }

            employees.forEach(user => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = user.name;
                row.insertCell().textContent = user.email;
                row.insertCell().textContent = user.department;
                row.insertCell().textContent = user.rfid;
                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.classList.add('btn');
                deleteBtn.style.backgroundColor = 'var(--error-color)';
                deleteBtn.style.width = 'auto';
                deleteBtn.style.padding = '0.5rem 1rem';
                deleteBtn.onclick = () => deleteUser(user.rfid);
                actionsCell.appendChild(deleteBtn);
            });
        }

        async function addNewUser(rfid = null) {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const department = document.getElementById('department').value;
            let finalRfid = rfid || document.getElementById('rfidInput').value.trim();

            if (!fullName || !email || !department) {
                showAlert('Input Error', 'Please fill in all user details (Full Name, Email, Department).', 'warning');
                return;
            }
            if (!finalRfid) {
                showAlert('RFID Missing', 'Please scan an RFID tag or generate one for the new user.', 'warning');
                return;
            }

            const userData = {
                name: fullName,
                email: email,
                department: department,
                rfid: finalRfid
            };

            try {
                const response = await fetch('/add_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                });

                const result = await response.json();
                if (response.ok) {
                    showAlert('Success', result.message, 'success');
                    // Clear form fields
                    document.getElementById('fullName').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('department').value = '';
                    document.getElementById('rfidInput').value = '';
                    document.getElementById('rfidDisplay').textContent = 'Waiting for Scan...';
                    scannedRfidForNewUser = ''; // Clear scanned RFID
                    fetchRegisteredUsers(); // Refresh the registered users table
                } else {
                    showAlert('Error', result.message || 'Failed to add user.', 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('Error', 'An error occurred while adding the user.', 'error');
            }
        }

        async function deleteUser(rfid) {
            if (!confirm(`Are you sure you want to delete user with RFID: ${rfid}?`)) {
                return;
            }
            try {
                const response = await fetch(`/delete_user/${rfid}`, {
                    method: 'DELETE',
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert('Success', result.message, 'success');
                    fetchRegisteredUsers(); // Refresh the table
                } else {
                    showAlert('Error', result.message || 'Failed to delete user.', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Error', 'An error occurred while deleting the user.', 'error');
            }
        }

        function generateRfidNoScan() {
            const mockRfid = '0x' + Math.floor(Math.random()*16777215).toString(16).toUpperCase();
            document.getElementById('rfidInput').value = mockRfid;
            showAlert('RFID Generated', `Generated RFID: ${mockRfid}. Click 'Add User' to save.`, 'info');
        }

        // This function will be called when the "Scan RFID to Assign" button is clicked
        async function scanRFIDForNewUser() {
            document.getElementById('rfidDisplay').textContent = 'Waiting for tap...';
            try {
                const response = await fetch('/scan_rfid_for_new_user');
                const data = await response.json();
                if (response.ok) {
                    scannedRfidForNewUser = data.rfid;
                    document.getElementById('rfidDisplay').textContent = scannedRfidForNewUser;
                    document.getElementById('rfidInput').value = scannedRfidForNewUser; // Populate the input field
                    showAlert('RFID Scanned', `RFID Tag: ${scannedRfidForNewUser} scanned. Now click 'Add User' to assign it.`, 'success');
                } else {
                    showAlert('Error', data.message || 'Failed to scan RFID. Try again.', 'error');
                    document.getElementById('rfidDisplay').textContent = 'Scan Failed';
                }
            } catch (error) {
                console.error('Error scanning RFID:', error);
                showAlert('Error', 'An error occurred during RFID scan simulation.', 'error');
                document.getElementById('rfidDisplay').textContent = 'Scan Error';
            }
        }

        // Employee Details (now uses the 'employees' array populated from backend)
        function renderEmployeeDetails() {
            const grid = document.getElementById('employeeDetailsGrid');
            grid.innerHTML = ''; // Clear existing cards

            if (employees.length === 0) {
                grid.innerHTML = '<p style="text-align: center; width: 100%; color: var(--text-light);">No employee details to display. Add users to see them here.</p>';
                return;
            }

            employees.forEach(employee => {
                const card = document.createElement('div');
                card.classList.add('employee-card');

                const initials = employee.name.split(' ').map(n => n[0]).join('').toUpperCase();
                // Assuming no profile images are uploaded for now, just use initials
                const profileHtml = `<div class="profile-initials">${initials}</div>`;

                card.innerHTML = `
                    ${profileHtml}
                    <h4>${employee.name}</h4>
                    <p>${employee.department}</p>
                    <p>${employee.email}</p>
                    <p>RFID: ${employee.rfid}</p>
                `;
                grid.appendChild(card);
            });
        }


        function setDateRange(preset, button) {
            const today = new Date();
            let startDate = new Date();
            let endDate = new Date();

            if (preset === 'today') {
                // Already set to today
            } else if (preset === 'yesterday') {
                startDate.setDate(today.getDate() - 1);
                endDate.setDate(today.getDate() - 1);
            } else if (preset === 'week') {
                const day = today.getDay(); // Sunday - Saturday : 0 - 6
                startDate = new Date(today.setDate(today.getDate() - day + (day === 0 ? -6 : 1))); // Start of week (Monday)
                endDate = new Date(); // End date is today
            } else if (preset === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            }

            document.getElementById('startDate').value = formatDate(startDate);
            document.getElementById('endDate').value = formatDate(endDate);

            // Remove active from all buttons and add to the clicked one
            document.querySelectorAll('.date-presets .date-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function formatDate(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        async function generateReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            showAlert('Generate Report', `Generating report for ${startDate} to ${endDate}.`, 'info');

            try {
                // Fetch attendance data for the selected date range from the backend
                const response = await fetch(`/summary?startDate=${startDate}&endDate=${endDate}`);
                const summary = await response.json();
                console.log("Fetched report summary:", summary); // Debugging
                updateReportsTable(summary);
            } catch (error) {
                console.error("Error fetching report summary:", error);
                showAlert('Error', 'Could not fetch report summary. Please check the backend server.', 'error');
            }
        }

        function updateReportsTable(summary) {
            const tableBody = document.querySelector('#reports #reportsTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (summary.detail && summary.detail.length > 0) {
                summary.detail.forEach(record => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = record.name;
                    row.insertCell().textContent = record.date;
                    row.insertCell().textContent = record.department;
                    row.insertCell().textContent = record.status;
                    row.insertCell().textContent = record.check_in_time;
                    row.insertCell().textContent = record.work_hours;
                });
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = 'var(--text-light)';
                cell.textContent = 'No records found for the selected date range.';
            }
        }

        function downloadReportExcel() {
            const table = document.getElementById('reportsTable');
            if (!table) {
                showAlert('Error', 'Report table not found.', 'error');
                return;
            }

            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");
            XLSX.writeFile(wb, "Attendance_Report.xlsx");
            showAlert('Download Complete', 'Attendance report downloaded as Excel.', 'success');
        }

        function downloadReportPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const table = document.getElementById('reportsTable');

            if (!table) {
                showAlert('Error', 'Report table not found.', 'error');
                return;
            }

            // Extract headers and data from the table
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
            const data = Array.from(table.querySelectorAll('tbody tr')).map(row =>
                Array.from(row.querySelectorAll('td')).map(td => td.innerText)
            );

            // Filter out the "No records found" row if it exists
            const filteredData = data.filter(row => row.length > 1 || row[0] !== 'No records found for the selected date range.');

            if (filteredData.length === 0) {
                showAlert('No Data', 'No data to download for the selected report.', 'warning');
                return;
            }

            doc.autoTable({
                head: [headers],
                body: filteredData,
                startY: 20
            });
            doc.text("Attendance Report", 14, 15);
            doc.save('Attendance_Report.pdf');
            showAlert('Download Complete', 'Attendance report downloaded as PDF.', 'success');
        }

        async function sendReportEmail() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const recipientEmail = document.getElementById('notificationEmail').value;

            if (!recipientEmail) {
                showAlert('Email Missing', 'Please enter a recipient email address in settings.', 'warning');
                return;
            }

            showAlert('Sending Email', `Preparing to send report to ${recipientEmail}...`, 'info');

            try {
                const response = await fetch('/send_report_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        startDate: startDate,
                        endDate: endDate,
                        recipient: recipientEmail
                    }),
                });

                const result = await response.json();
                if (response.ok) {
                    showAlert('Email Sent', result.message, 'success');
                } else {
                    showAlert('Email Failed', result.message || 'Failed to send email.', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showAlert('Error', 'An error occurred while sending the email.', 'error');
            }
        }


        // Settings functions
        function saveSettings() {
            const settings = {
                checkInStart: document.getElementById('checkInStart').value,
                checkInEnd: document.getElementById('checkInEnd').value,
                workDays: {
                    monday: document.getElementById('monday').checked,
                    tuesday: document.getElementById('tuesday').checked,
                    wednesday: document.getElementById('wednesday').checked,
                    thursday: document.getElementById('thursday').checked,
                    friday: document.getElementById('friday').checked,
                    saturday: document.getElementById('saturday').checked,
                    sunday: document.getElementById('sunday').checked,
                },
                notifyLateArrivals: document.getElementById('notifyLateArrivals').checked,
                notifyAbsences: document.getElementById('notifyAbsences').checked,
                emailSummary: document.getElementById('emailSummary').checked,
                notificationEmail: document.getElementById('notificationEmail').value,
                comPort: document.getElementById('comPort').value,
                baudRate: document.getElementById('baudRate').value,
            };

            fetch('/save_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Settings Saved', data.message, 'success');
                } else {
                    showAlert('Error', data.message || 'Failed to save settings.', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showAlert('Error', 'An error occurred while saving settings.', 'error');
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/load_settings');
                const settings = await response.json();
                if (settings) {
                    document.getElementById('checkInStart').value = settings.checkInStart || '09:00';
                    document.getElementById('checkInEnd').value = settings.checkInEnd || '10:00';
                    if (settings.workDays) {
                        document.getElementById('monday').checked = settings.workDays.monday || false;
                        document.getElementById('tuesday').checked = settings.workDays.tuesday || false;
                        document.getElementById('wednesday').checked = settings.workDays.wednesday || false;
                        document.getElementById('thursday').checked = settings.workDays.thursday || false;
                        document.getElementById('friday').checked = settings.workDays.friday || false;
                        document.getElementById('saturday').checked = settings.workDays.saturday || false;
                        document.getElementById('sunday').checked = settings.workDays.sunday || false;
                    }
                    document.getElementById('notifyLateArrivals').checked = settings.notifyLateArrivals !== undefined ? settings.notifyLateArrivals : true;
                    document.getElementById('notifyAbsences').checked = settings.notifyAbsences !== undefined ? settings.notifyAbsences : true;
                    document.getElementById('emailSummary').checked = settings.emailSummary !== undefined ? settings.emailSummary : true;
                    document.getElementById('notificationEmail').value = settings.notificationEmail || 'admin@example.com';
                    document.getElementById('comPort').value = settings.comPort || 'COM7';
                    document.getElementById('baudRate').value = settings.baudRate || '9600';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use default values if loading fails
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Initial date range for reports is set when 'reports' section is shown
            // No initial fetch of attendance summary here, it will be triggered by RFID tap
        });

        // WebSocket for real-time RFID updates
        let ws;
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:5000/ws');

            ws.onopen = () => {
                console.log('WebSocket connected');
                // Optionally send a message to the server
                // ws.send('Hello from client!');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);

                if (data.type === 'rfid_tap') {
                    // Only update dashboard attendance if an RFID card was tapped
                    fetchAttendanceSummary();
                    showAlert('RFID Tap Detected', `RFID: ${data.uid} tapped. Attendance updated.`, 'info');
                } else if (data.type === 'new_user_rfid_scan') {
                    // This is for the 'Scan RFID to Assign' functionality
                    scannedRfidForNewUser = data.uid;
                    document.getElementById('rfidDisplay').textContent = scannedRfidForNewUser;
                    document.getElementById('rfidInput').value = scannedRfidForNewUser; // Populate the input field
                    showAlert('RFID Scanned', `RFID Tag: ${scannedRfidForNewUser} scanned. Now click 'Add User' to assign it.`, 'success');
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting in 5 seconds...');
                setTimeout(connectWebSocket, 5000); // Attempt to reconnect after 5 seconds
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Call connectWebSocket when the page loads
        document.addEventListener('DOMContentLoaded', connectWebSocket);
    </script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
